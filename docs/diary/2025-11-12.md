# 2025-11-12 作業記録

## 実施内容

### Visual Thinking（vt）への大規模リファクタリング

イラストビュー機能を「Visual Thinking」というコンセプトに刷新し、URLやファイル名を全面的に変更した。

#### 背景

- 「illust」という名称が内容を正確に表していない
- xkcd風のイラストは単なる「イラスト」ではなく「視覚的思考（Visual Thinking）」を表現している
- より明確なブランディングが必要

#### 実施内容

**Phase 0: URL構造の変更**

```
変更前: /ja/illust/001
変更後: /ja/vt/1
```

- ディレクトリ: `pages/[lang]/illust/` → `pages/[lang]/vt/`
- 設定ファイル: `illust_config.json` → `vt_config.json`
- 全てのURL参照を更新

**Phase 1: ID形式の変更**

```json
// Before
{"id": "001", ...}

// After
{"id": 1, ...}
```

- ゼロパディングを削除（999件制限の撤廃）
- 文字列から数値に変更
- `padStart(3, "0")` のロジックを削除

**影響範囲**:
- `vt_config.json`: IDを数値に変更、`skipped` 配列を追加
- `pages/[lang]/vt/index.tsx`: 型定義、configPath、URL生成
- `pages/[lang]/vt/[page].tsx`: 型定義、ID比較ロジック、ナビゲーション
- 全てのテキストを「Illustrations」→「Visual Thinking」に更新

**破壊的変更**:
- 既存のURL（`/ja/illust/001`など）は無効になる
- 新しいURL: `/ja/vt/1`, `/ja/vt/2`, ...

### 管理者ページの実装

Visual Thinkingのコンテンツを管理するための専用管理画面を実装した。

#### 実装した機能

**1. API Routes**

- `POST /api/vt/scan` - ページスキャン
  - `data/ja/pages/` 内の全Markdownファイルをスキャン
  - Gyazo画像を含むページを検出
  - 既に登録済み・スキップ済みのページを除外
  - 6055件の候補を検出

- `POST /api/vt/add` - イラスト追加
  - `vt_config.json` の `illusts` 配列に追加
  - 自動ID採番（最大ID + 1）
  - ページ名、タグを管理

- `POST /api/vt/skip` - スキップ登録
  - `vt_config.json` の `skipped` 配列に追加
  - スキップしたページは今後の候補から除外

**2. Admin UI (`/admin/vt`)**

- **アクセス制御**: 開発環境（`NODE_ENV === 'development'`）のみアクセス可能
- **スキャン機能**: 「Scan Pages」ボタンで候補を一覧表示
- **検索/フィルター**: テキスト入力でリアルタイム絞り込み（タイトル・ページ名）
- **グリッド表示**: 画像サムネイル付きカードレイアウト（300px幅）
- **Add/Skipボタン**: 各ページに対してワンクリック操作

**3. UX改善**

- **ローディング状態の可視化**
  - Scanボタンにスピナーアニメーション
  - メッセージボックスがパルスアニメーション（処理中は点滅）
  - アイコンでフィードバック: 🔍 Scanning... → ✅ Found N candidates / ❌ Error

- **Scrapboxリンク**
  - タイトルをクリックすると `https://scrapbox.io/nishio/<ページ名>` が開く
  - 新しいタブで開く（`target="_blank"`）

- **統計表示**
  - 「Showing N / M candidates」で絞り込み状態を表示

#### vt_config.json の構造

```json
{
  "illusts": [
    {
      "id": 1,
      "page_ja": "ブロードリスニング",
      "page_en": null,
      "tags": ["xkcd", "communication", "democracy"]
    }
  ],
  "skipped": [
    "#Ｚ世代的価値観",
    "'cy' is not defined",
    "1%の革命",
    "01VERSE"
  ]
}
```

- `illusts`: 登録済みのイラスト一覧
- `skipped`: 管理者が「追加しない」と判断したページ一覧

### Scrapbox APIエラーハンドリング

`pages/legacy/[page].tsx` で発生していたエラーを修正した。

#### 問題

```
TypeError: Cannot read properties of undefined (reading 'map')
```

- Scrapbox APIが無効なレスポンスを返した場合
- `json.lines` が `undefined` になり、`.map()` を呼び出してエラー

#### 修正内容

```typescript
// Handle case when page doesn't exist or API returns invalid data
if (!json || !json.lines || !Array.isArray(json.lines)) {
  return {
    props: {
      date: Date.now(),
      content: parse(""),
      exists: false,
      project,
      page: ctx.params!!.page as string,
      json: {
        id: "",
        title: ctx.params!!.page as string,
        lines: [],
        descriptions: [],
        image: "",
        relatedPages: { links1hop: [], links2hop: [] },
      },
    },
    revalidate: 30,
  };
}
```

- `json.lines` が存在しない場合のエラーハンドリングを追加
- 空のページデータを返してエラーを防ぐ

### TypeScriptビルドエラーの修正

リファクタリング後、TypeScriptのコンパイルエラーが2件発生した。CLAUDE.mdに「pushする前に必ずローカルでビルドして型エラーを確認すること」と書いたにもかかわらず、実際には確認せずにpushしてしまった。

#### エラー1: illustId型の不一致

**ファイル**: `pages/[lang]/vt/[page].tsx:100`

**エラーメッセージ**:
```
Type 'string' is not assignable to type 'number'
```

**原因**:
- `illustItem` が見つからない場合のエラーハンドリングで `illustId: page` としていた
- `page` は `string` 型だが、Props の型定義では `illustId: number` を要求

**修正前**:
```typescript
if (!illustItem) {
  return {
    props: {
      illustId: page,  // page は string
      // ...
    },
  };
}
```

**修正後**:
```typescript
if (!illustItem) {
  return {
    props: {
      illustId: parseInt(page, 10),  // number に変換
      // ...
    },
  };
}
```

#### エラー2: TScrapboxPageJSON の links プロパティ欠落

**ファイル**: `pages/legacy/[page].tsx:30`

**エラーメッセージ**:
```
Property 'links' is missing in type {...} but required in type 'TScrapboxPageJSON'
```

**原因**:
- Scrapbox APIエラーハンドリングを追加した際、ダミーの `json` オブジェクトを作成
- `TScrapboxPageJSON` 型で要求される `links` プロパティを含め忘れた

**修正前**:
```typescript
json: {
  image: "",
  descriptions: [],
  lines: [],
  // links: [],  // 欠落！
  relatedPages: { links1hop: [], links2hop: [] },
}
```

**修正後**:
```typescript
json: {
  image: "",
  descriptions: [],
  lines: [],
  links: [],  // 追加
  relatedPages: { links1hop: [], links2hop: [] },
}
```

#### 発見の経緯

1. CLAUDE.mdに「pushする前に必ず `yarn build` を実行すること」と記述
2. その直後に、ビルド確認せずにpush
3. ユーザーから「pushした？」「ビルド通ってる？」と質問される
4. 慌てて `yarn build` を実行 → ローカルでは成功（51.23秒）
5. Vercelのデプロイログでエラーを確認
6. 2つのエラーを修正してpush

#### 学んだこと

**自分が書いたルールは必ず守ること**。特に：
- TypeScriptのビルドは必ず実行してから push
- ローカルで成功してもVercelで失敗する可能性がある
- 型の不一致は実行時エラーにはならないが、TypeScriptの型チェックで検出できる
- 防御的プログラミングでダミーオブジェクトを作る際は、型定義を完全に満たすこと

**コミット**:
```
1d7f59e fix: correct illustId type in error case
6d80ceb fix: add missing links property to TScrapboxPageJSON
e9dc958 docs: add CLAUDE.md with development guidelines
```

### Markdownページへのscrapboxリンク追加

日本語・英語のMarkdownページ（`/ja/<ページ名>`、`/en/<ページ名>`）のフッターにScrapboxリンクを追加した。

#### 実装内容

```tsx
Source:{" "}
<a
  href={`https://github.com/nishio/external_brain_in_markdown${
    props.lang === "en" ? "_english" : ""
  }/blob/main/pages/${props.page}.md`}
  target="_blank"
>
  [GitHub]
</a>
{" / "}
<a
  href={`https://scrapbox.io/${props.lang === "ja" ? "nishio" : "nishio-en"}/${props.page}`}
  target="_blank"
>
  [Scrapbox]
</a>
```

- 日本語ページ: `https://scrapbox.io/nishio/<ページ名>`
- 英語ページ: `https://scrapbox.io/nishio-en/<ページ名>`
- 表示形式: `[GitHub] / [Scrapbox]`

### イラストの追加

管理画面を使って12件のイラストを追加した。

**追加されたイラスト（ID 4-12）**:
1. 3つのイデオロギーの間に2つの対立軸がある
2. AIにまず語らせる
3. AI時代の技術力獲得プロセス
4. AはBよりX
5. AがBを包んでいる
6. Aから見てBがXだが、Bから見てAもX
7. Aかnot Aかの議論
8. FLAT-STEP→NAMERAKA
9. FitとDevelopは誤った二項対立

**スキップしたページ（4件）**:
- #Ｚ世代的価値観
- 'cy' is not defined
- 1%の革命
- 01VERSE

## 技術的詳細

### 破壊的変更の影響

**旧URL**: `/ja/illust/001`
**新URL**: `/ja/vt/1`

- 既存のブックマークやリンクは無効になる
- ただし、イラストが少ない段階での変更なので影響は最小限
- Vercelの自動デプロイで即座に反映

### ID生成ロジック

```typescript
// Before
const getNextId = () => {
  const maxId = Math.max(...config.illusts.map(i => parseInt(i.id)));
  return String(maxId + 1).padStart(3, "0");
};

// After
const getNextId = () => {
  const maxId = Math.max(...config.illusts.map(i => i.id), 0);
  return maxId + 1;
};
```

- シンプルで保守性が高い
- 999件制限がない

### 開発環境のみアクセス可能な管理画面

```typescript
export const getServerSideProps: GetServerSideProps = async () => {
  // Only allow in development environment
  if (process.env.NODE_ENV !== "development") {
    return {
      notFound: true,
    };
  }

  return {
    props: {},
  };
};
```

- 本番環境では404を返す
- セキュリティリスクを最小化

## コミット履歴

### memリポジトリ

```
196208a feat: add Scrapbox link to Markdown pages
0b8609a fix: handle invalid Scrapbox API responses
393b40c improve: enhance admin page UX
d8856e7 feat: add admin page for Visual Thinking management
9e0dd96 refactor: rename illust to vt and change ID format
564bd5e docs: add illust view improvement plan
```

### 管理リポジトリ（external_brain_management）

```
66c6019 chore: update mem submodule (add Scrapbox links)
577ae46 chore: update mem submodule (API error handling fix)
818f3d8 chore: update mem submodule (vt rename and admin page)
```

## 学んだこと

### 1. 早期の破壊的変更の重要性

コンテンツが少ない段階（3件→12件）で大規模なリファクタリングを実施できたのは良かった。URL構造の変更は後になるほど困難になる。

### 2. 管理画面の重要性

手動でJSONを編集するのは：
- 時間がかかる
- ミスが発生しやすい
- ID採番が面倒

管理画面があることで：
- 6055件の候補から簡単に選択できる
- 検索/フィルターで効率的に探せる
- スキップ機能で「追加しない」判断を記録できる

### 3. ローディング状態の可視化

時間がかかる処理（6055件のスキャン）では、ユーザーに進捗を伝えることが重要：
- スピナーアニメーション
- メッセージの更新（🔍 → ✅）
- パルスアニメーション

### 4. エラーハンドリングの重要性

Scrapbox APIのような外部APIは、常に正常なレスポンスを返すとは限らない。防御的プログラミングが必要。

### 5. Scrapboxへのリンクの価値

MarkdownページからScrapboxの元ページに簡単に移動できることで、ユーザーエクスペリエンスが向上する。

## 今後のタスク

### 短期（1-2日）

- [ ] さらにイラストを追加（目標: 20-30件）
- [ ] トップページから Visual Thinking へのリンクを追加
- [ ] メタデータ（作成日など）の表示

### 中期（1週間）

- [ ] 英語版ページの対応（`page_en` フィールドの活用）
- [ ] タグ機能の実装（内部リンク `[[リンク]]` からタグ抽出）
- [ ] 同じタグのイラストへのナビゲーション

### 長期（1ヶ月）

- [ ] スキップ解除機能
- [ ] 並び替え機能（ドラッグ&ドロップ）
- [ ] バルク追加（複数選択）
- [ ] 管理画面の認証（環境変数による簡易認証）

## メモ

- Visual Thinking機能は動作確認済み（開発環境）
- 管理画面で12件のイラストを追加完了
- Vercelへの自動デプロイ完了（`/ja/vt/1` などのURL有効）
- PLAN_ILLUST_IMPROVEMENT.md の Phase 0-3 すべて完了

## 参考資料

- [PLAN_ILLUST_IMPROVEMENT.md](../modules/mem/PLAN_ILLUST_IMPROVEMENT.md)
- [xkcd.com](https://xkcd.com/) - ナビゲーションデザインの参考
- [2025-11-11 作業記録](2025-11-11.md) - 前日の初期実装
