# 2025-11-11 作業記録

## 実施内容

### イラストビュー実装計画の策定

memリポジトリにxkcd風のイラスト表示機能を追加する計画を立案・文書化した。

#### URL設計の検討

**検討した2つの案**:
- `/illust/ja/<page>` - コンテンツタイプを最上位に配置
- `/ja/illust/<page>` - 言語コードを最上位に配置（採用）

**採用理由**:
- 言語コードを最上位に置くのが国際化（i18n）のベストプラクティス
- 検索エンジン（Google等）も推奨
- Next.jsのi18nルーティング機能と自然に統合できる
- 既存の`/ja/<page>`構造と一貫性がある
- 拡張性がある（`/ja/gallery/<page>`なども追加可能）

#### Next.jsのi18nルーティング

Next.jsには2つのアプローチがある：

1. **動的ルーティング**（memの現在の実装）
   ```
   pages/[lang]/[page].tsx → /ja/some-page, /en/some-page
   ```

2. **next.config.jsのi18n設定**（Next.js 10+）
   ```javascript
   module.exports = {
     i18n: {
       locales: ['ja', 'en'],
       defaultLocale: 'ja',
     },
   }
   ```
   - 自動で`/ja/page`、`/en/page`にルーティング
   - デフォルト言語なら`/page`も許可
   - `Accept-Language`ヘッダーで自動リダイレクト

### PR#1のマージ確認

memリポジトリのPR#1（リダイレクトロジックとrewritesの追加）がマージされた。

**主な変更**:
- `/<page>` → `/legacy/<page>` へのrewrite追加
- `pages/nishio/[page].tsx` → `pages/legacy/[page].tsx` にリネーム
- 互換性維持のため既存のURLをサポート

**現在のルーティング構造**:
```
/                       → トップ
/dashboard              → ダッシュボード
/<page>                 → /legacy/<page> (rewrite)
/legacy/<page>          → Scrapbox API
/ja/<page>              → Markdown (日本語)
/en/<page>              → Markdown (英語)
```

### データソースの決定

**オプションA（既存Markdown + JSON設定）を採用**:
- 既存のMarkdownファイル（`data/ja/pages/*.md`）を使用
- JSON設定ファイルで表示対象を管理
- 段階的実装：まず3つのイラストから開始

**設定ファイル構造**:
```json
{
  "illusts": [
    {
      "id": "001",
      "page_ja": "ブロードリスニング",
      "page_en": null,
      "tags": ["xkcd", "communication"]
    }
  ]
}
```

**初期イラスト3件**:
1. 001: ブロードリスニング
2. 002: ツリーとリゾーム
3. 003: 単語を変えると誤解が拡大する

### 英語版対応の設計

**実装方針**:
- 同じIDで日英をマッピング
- `/ja/illust/001` ↔ `/en/illust/001`
- `page_ja`と`page_en`フィールドで管理
- 英語版が存在しない場合（`page_en: null`）は404またはリダイレクト

### xkcd風ナビゲーション

```
|< <Prev Random Next> >|
```

- `|<` : 最初のイラストへ
- `<Prev` : 前のイラストへ
- `Random` : ランダムなイラストへ
- `Next>` : 次のイラストへ
- `>|` : 最後のイラストへ

### PLAN.mdの作成とコミット

`modules/mem/PLAN.md` を作成し、以下の内容を文書化：
- 現在のルーティング構造
- イラストビューの設計（URL、データソース、レイアウト）
- 実装手順（フェーズ0-3）
- 決定事項まとめ
- 未解決/検討中の項目

**コミット履歴**:
```
58a1072 docs: add illustration view implementation plan (mem)
c25785b chore: update mem submodule pointer (parent repo)
```

### Devinによる実装の取り込み

別の開発者（Devin）がイラストビュー機能を実装し、PR#2がマージされた。

**追加されたファイル（655行）**:
1. `illust_config.json` - イラスト設定ファイル
2. `pages/[lang]/illust/[page].tsx` - 個別イラストページ
3. `pages/[lang]/illust/index.tsx` - イラスト一覧ページ

**最新のコミット**:
- `ec1cb26` Merge pull request #2
- `f85465d` 個別ページのレイアウト改善（wide画面用）
- `65f4f0b` モバイルレイアウトを3列に変更
- `62112be` モバイルレスポンシブ対応改善

### リポジトリの更新

memサブモジュールと管理リポジトリを最新に更新：

```bash
cd modules/mem
git pull origin master  # イラストビュー実装を取得

cd ../..
git add modules/mem
git commit -m "chore: update mem submodule to include illust view implementation"
git push origin main
```

**最終コミット**: `739d7e4`

## macOSのUnicode正規化問題

### 問題の概要

`modules/external_brain_in_markdown`サブモジュールで、何度リセットしても以下のような変更が表示され続ける問題が発生した：

```
Changes not staged for commit:
	modified:   pages/Bashi.md
	modified:   pages/Ikigai.md
	modified:   pages/百聞百見は一騙にしかず.md
	modified:   pages/自作カードゲーム試作品の作り方.md
	modified:   pages/非営利組織のリーダーにとって人の成長を考えることは必須.md
```

ファイルの内容自体に変更はないが、ファイル名の表現方法が異なるため、Gitが変更として認識してしまう。

### Unicode正規化とは

Unicode文字には複数の表現方法が存在する場合がある。特に日本語の濁点・半濁点を含む文字が問題になる。

#### 例：「が」の2つの表現

1. **合成文字（NFC: Normalization Form Composition）**
   - 1文字として表現: `が` (U+304C)
   - Windows、Linux、GitHub/GitLabのデフォルト

2. **分解文字（NFD: Normalization Form Decomposition）**
   - ベース文字 + 濁点: `か` (U+304B) + `゛` (U+3099)
   - macOSのファイルシステム（HFS+/APFS）のデフォルト

#### その他の例

- **「カ」**（カタカナ）
  - NFC: `カ` (U+30AB)
  - NFD: `カ` (U+30AB) + `゛` (U+3099)

- **「パ」**（半濁点）
  - NFC: `パ` (U+30D1)
  - NFD: `ハ` (U+30CF) + `゜` (U+309A)

- **「Looker Studio」の問題**
  - ファイル名: `Looker Studio.md`
  - macOSのファイルシステムでは内部的にNFDで保存
  - `Looker Studio.md` vs `looker studio.md` の大文字小文字問題も混在

### なぜmacOSだけこうなのか

**歴史的経緯**:
1. macOSの前身であるMac OSは、日本語を扱う際にNFDを採用した
2. HFS+ファイルシステムがNFDを強制的に使用
3. APFSでもこの仕様が引き継がれた（互換性のため）
4. 一方、Windows/LinuxはNFCがデフォルト

**理由**:
- NFDの方が検索処理が効率的（ベース文字で検索できる）
- 旧Mac OSとの互換性維持
- ただし、他のOSとの相互運用性に問題が生じる

### Gitでの問題

#### 何が起こるか

1. GitHubのリポジトリにはNFC形式でファイル名が保存される
2. macOSでclone/checkoutすると、ファイルシステムが自動的にNFDに変換
3. `git status`を実行すると、GitはNFC（リポジトリ）とNFD（ローカル）を比較
4. 内容が同じでも、ファイル名の正規化形式が異なるため「modified」と表示される

#### 具体例

リポジトリ（NFC）:
```
百聞百見は一騙にしかず.md
```
- `騙` = U+9A19 (1文字)

macOSローカル（NFD）:
```
百聞百見は一騙にしかす゛.md
```
- `す` = U+3059 (1文字)
- `゛` = U+3099 (濁点、別文字)

### 解決方法

#### 1. Git設定の追加（推奨）

```bash
git config core.precomposeunicode true
```

**効果**:
- Gitがファイル名をNFCに正規化してから比較する
- macOS特有の問題を軽減
- ただし、すべてのケースで完全に解決するわけではない

#### 2. .gitattributesの設定

```bash
# .gitattributes
* text=auto
*.md text eol=lf
```

これによりテキストファイルの改行コードも統一できる。

#### 3. サブモジュールのクリーンアップ

問題が深刻な場合は、サブモジュールを完全に削除して再取得：

```bash
# サブモジュールの初期化解除
git submodule deinit -f modules/external_brain_in_markdown

# ディレクトリの削除
rm -rf modules/external_brain_in_markdown
rm -rf .git/modules/modules/external_brain_in_markdown

# Gitインデックスから削除
git rm -f modules/external_brain_in_markdown

# 再追加
git submodule add https://github.com/nishio/external_brain_in_markdown modules/external_brain_in_markdown

# クリーンな状態で初期化
git reset --hard HEAD
git submodule update --init --recursive
```

#### 4. 実用的な対処法（今回採用）

実質的なコンテンツの変更がない場合は**無視する**のが現実的：

- Scrapboxからの自動更新で定期的に上書きされる
- 実際のコンテンツに影響がない
- コミットしても次の自動更新で元に戻る可能性がある
- 開発作業には支障がない

### 今後の対策

#### リポジトリレベル

1. `.gitattributes`を追加してテキストファイルの扱いを明示
2. CI/CDでUnicode正規化チェックを追加（必要な場合）

#### 個人設定

```bash
# グローバル設定として追加
git config --global core.precomposeunicode true
```

#### チーム共有

- 開発者全員がmacOSを使用する場合は問題が表面化しにくい
- Windows/Linuxユーザーとの混在環境では注意が必要
- READMEやドキュメントに問題と対処法を記載

### 参考リンク

- [Git - core.precomposeunicode](https://git-scm.com/docs/git-config#Documentation/git-config.txt-coreprecomposeunicode)
- [Unicode Normalization Forms](https://unicode.org/reports/tr15/)
- [Apple File System Reference](https://developer.apple.com/documentation/foundation/filemanager)

## 学んだこと

1. **URL設計の重要性**: 言語コードを最上位に配置することで、i18nのベストプラクティスに従い、拡張性も確保できる

2. **段階的実装の有効性**: まず小さく始める（3つのイラスト）ことで、早期にフィードバックを得られる

3. **設定ファイルによる管理**: 既存のMarkdownファイルを変更せず、JSONで表示対象を管理することで、柔軟性と保守性を両立

4. **macOSのUnicode正規化問題**: ファイルシステムレベルの違いがGitの動作に影響を与える具体例。実害がない場合は無視するのも選択肢

5. **サブモジュール管理**: 完全にクリーンアップして再取得する手順を理解

## 今後のタスク

### イラストビュー機能（フェーズ2以降）

- [ ] ナビゲーション機能の改善（xkcd風の5ボタン）
- [ ] 複数イラストの追加（10-20件程度）
- [ ] メタデータ表示の拡張（タグ、作成日）
- [ ] デザイン改善（レスポンシブ対応、画像最適化）

### イラストビュー機能（フェーズ3）

- [ ] 設定ファイルの自動生成スクリプト（Python）
- [ ] 英語版対応の実装
- [ ] 日英マッピング管理

### リポジトリ管理

- [ ] `.gitattributes`の追加（Unicode正規化問題への対処）
- [ ] 開発ガイドラインへのUnicode正規化問題の記載

## コミット履歴

### memサブモジュール
```
58a1072 docs: add illustration view implementation plan
ec1cb26 Merge pull request #2 from nishio/devin/1762834682-implement-illust-view
f85465d refactor: improve individual page layout for wide screens
65f4f0b refactor: change mobile layout to 3 columns
62112be refactor: improve mobile responsive layout for illust index
44143e9 refactor: improve individual illust page layout
```

### 管理リポジトリ（external_brain_management）
```
739d7e4 chore: update mem submodule to include illust view implementation
c25785b chore: update mem submodule pointer
cab2867 docs: add data pipeline investigation to diary
```

## メモ

- memのイラストビューは動作確認済み
- external_brain_in_markdownのUnicode正規化問題は実害なし（無視）
- PLAN.mdは良いドキュメントになった（将来の参考になる）
- Devinの実装は予想以上に完成度が高い（レスポンシブ対応まで含む）
